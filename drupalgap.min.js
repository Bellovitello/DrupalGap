/*! drupalgap 2015-12-30 */
var dg={},drupalgap=dg;dg.activeTheme=null,dg.regions=null,dg.blocks=null,dg.settings={mode:"web-app",front:null,blocks:{}},dg.config=function(a){var b=arguments[1]?arguments[1]:null;return b?void(dg.settings[a]=b):dg.settings[a]},dg.getMode=function(){return this.config("mode")},dg.setMode=function(a){this.config("mode",a)},dg.start=function(){"phonegap"==dg.getMode()?document.addEventListener("deviceready",dg.deviceready,!1):dg.deviceready()},dg.deviceready=function(){return dg.bootstrap(),jDrupal.isReady()?void jDrupal.connect().then(this.devicereadyGood,this.devicereadyBad):void dg.alert("Set the sitePath in the settings.js file!")},dg.devicereadyGood=function(){dg.router.check(dg.router.getFragment())},dg.devicereadyBad=function(){var a="Failed connection to "+jDrupal.sitePath();""!=msg&&(a+=" - "+msg),dg.alert(a,{title:"Unable to Connect",alertCallback:function(){}})},dg.bootstrap=function(){jDrupal.modules.dgSystem={},jDrupal.modules.dgUser={},dg.router.config({});var a=jDrupal.modulesLoad();for(var b in a)if(a.hasOwnProperty(b)&&window[b].routing){var c=window[b].routing();if(c)for(route in c)if(c.hasOwnProperty(route)){var d=c[route];dg.router.add(d)}}dg.themeLoad().then(function(){dg.blocksLoad();dg.router.add(function(){}).listen()})},dg.Block=function(a){this.format="div";for(var b in a)a.hasOwnProperty(b)&&(this[b]=a[b])},dg.Block.prototype.get=function(a){return"undefined"!=typeof this[a]?this[a]:null},dg.Block.prototype.set=function(a,b){this[a]=b},dg.Block.prototype.buildWrapper=function(){var a=this;return new Promise(function(b,c){a.build().then(function(c){a.set("content",c),b(a)})})},dg.Block.prototype.build=function(){return new Promise(function(a,b){a("")})},dg.blocksLoad=function(){if(dg.blocks)return dg.blocks;dg.blocks={};var a={},b=dg.config("theme").name,c=drupalgap.settings.blocks[b],d=0;for(var e in c)if(c.hasOwnProperty(e))for(var f in c[e])if(c[e].hasOwnProperty(f)){var g=c[e][f];g.region=e,a[f]=g,d++}if(0==d){var h='WARNING: No blocks were found for the "'+b+'" theme in settings.js';console.log(h)}var i=jDrupal.modulesLoad();for(var j in i)if(i.hasOwnProperty(j)&&window[j].blocks){var k=window[j].blocks();if(k)for(g in k)if(k.hasOwnProperty(g)&&a[g]){var l=k[g];if(l.id||(l.id=g),l.module||(l.module=j),l.attributes||(l.attributes={}),l.attributes.id||(l.attributes.id=g),dg.blocks[g]){var h='WARNING - The "'+g+'" block provided by the "'+dg.blocks[g].get("module")+'" module has been overwritten by the "'+l.module+'" module.';console.log(h)}dg.blocks[g]=new dg.Block(l);for(var m in a[g])a[g].hasOwnProperty(m)&&dg.blocks[g].set(m,a[g][m])}}return dg.blocks},dg.blockLoad=function(a){return dg.blocks[a]?dg.blocks[a]:null},dg.attributes=function(a){var b="";if(a)for(var c in a)if(a.hasOwnProperty(c)){var d=a[c];Array.isArray(d)?b+=c+'="'+d.join(" ")+'" ':""!=d?b+=c+'="'+d+'" ':"class"!=c&&(b+=c+" ")}return b},dg.getCamelCase=function(a){return a.replace(/[-_]([a-z])/g,function(a){return a[1].toUpperCase()})},dg.killCamelCase=function(a,b){return jDrupal.lcfirst(a).replace(/([A-Z])/g,b+"$1").toLowerCase()},dg.Node=function(a){return new jDrupal.Node(a)},dg.FormElement=function(a,b,c){this.name=a,this.element=b,this.form=c},dg.FormElement.prototype.id=function(){return this.element._attributes.id},dg.FormElement.prototype.getForm=function(){return this.form},dg.FormElement.prototype.get=function(a){return this[a]},dg.FormElement.prototype.valueCallback=function(){var a=this;return new Promise(function(b,c){var d=null,e=document.getElementById(a.id());e&&(d=e.value),b({name:a.get("name"),value:d})})},dg.theme_actions=function(a){var b="";for(prop in a)dg.isFormElement(prop,a)&&(b+=dg.render(a[prop]));return b},dg.theme_password=function(a){return a._attributes.type="password","<input "+dg.attributes(a._attributes)+" />"},dg.theme_submit=function(a){a._attributes.type="submit";var b="Submit";return a._attributes.value||"undefined"!=typeof a._value&&(b=a._value),a._attributes.value=b,"<input "+dg.attributes(a._attributes)+"/>"},dg.theme_textfield=function(a){return a._attributes.type="text","<input "+dg.attributes(a._attributes)+"/>"},dg.FormStateInterface=function(a){this.form=a,this.values={},this.errors={}},dg.FormStateInterface.prototype.get=function(a){return"undefined"!=typeof this[a]?this[a]:null},dg.FormStateInterface.prototype.set=function(a,b){this[a]=b},dg.FormStateInterface.prototype.setFormState=function(){var a=this,b=a.get("form"),c=[];for(var d in b.elements)c.push(b.elements[d].valueCallback());return Promise.all(c).then(function(b){for(var c=0;c<b.length;c++)a.setValue(b[c].name,b[c].value)})},dg.FormStateInterface.prototype.setErrorByName=function(a,b){this.errors[a]=b},dg.FormStateInterface.prototype.getErrors=function(){return this.errors},dg.FormStateInterface.prototype.hasAnyErrors=function(){var a=!1,b=this.getErrors();for(error in b)if(b.hasOwnProperty(error)){a=!0;break}return a},dg.FormStateInterface.prototype.getErrorMessages=function(){var a="",b=this.getErrors();for(error in b)b.hasOwnProperty(error)&&(a+=error+" - "+b[error]);return a},dg.FormStateInterface.prototype.displayErrors=function(){dg.alert(this.getErrorMessages())},dg.FormStateInterface.prototype.getValue=function(a,b){return"undefined"!=typeof this.get("values")[a]?this.get("values")[a]:b},dg.FormStateInterface.prototype.setValue=function(a,b){this.values[a]=b},dg.FormStateInterface.prototype.getValues=function(){return this.get("values")},dg.FormStateInterface.prototype.setValues=function(a){this.values=a},dg.forms={},dg.Form=function(a){this.id=a,this.form={_attributes:{id:dg.killCamelCase(a,"-").toLowerCase()},_validate:[a+".validateForm"],_submit:[a+".submitForm"]},this.form_state=new dg.FormStateInterface(this),this.elements={}},dg.Form.prototype.getFormId=function(){return this.id},dg.Form.prototype.getForm=function(){var a=this;return new Promise(function(b,c){a.buildForm(a.form,a.form_state).then(function(){for(name in a.form)if(dg.isFormElement(name,a.form)){var c=a.form[name];if("actions"==c._type)for(_name in c)dg.isFormElement(_name,c)&&dg.setFormElementDefaults(_name,c[_name]);else dg.setFormElementDefaults(name,c)}var d=jDrupal.moduleInvokeAll("form_alter",a.form,a.getFormState(),a.getFormId()),e=function(){for(var c in a.form)dg.isFormElement(c,a.form)&&(a.elements[c]=new dg.FormElement(c,a.form[c],a));b("<form "+dg.attributes(a.form._attributes)+">"+dg.render(a.form)+"</form>")};d?d.then(e):e()})})},dg.Form.prototype.getFormState=function(){return this.form_state},dg.Form.prototype.buildForm=function(a,b,c){return new Promise(function(a,b){a()})},dg.Form.prototype.validateForm=function(a){return new Promise(function(a,b){a()})},dg.Form.prototype.submitForm=function(a,b,c){return new Promise(function(a,b){a()})},dg.Form.prototype._submission=function(){var a=this;return new Promise(function(b,c){var d=a.getFormState();d.setFormState().then(function(){a._validateForm().then(function(){return d.hasAnyErrors()?(d.displayErrors(),void c()):void a._submitForm(a,d).then(function(){a.form._action&&dg["goto"](a._action),dg.removeForm(a.getFormId()),b()})})})})},dg.Form.prototype._validateForm=function(){for(var a=this,b=[],c=0;c<a.form._validate.length;c++){var d=a.form._validate[c].split("."),e=d[0],f=d[1];e!=this.getFormId()||"validateForm"!=f?window[e]&&window[e][f]&&b.push(window[e][f].apply(a,[a,a.getFormState()])):b.push(this[f].apply(a,[a,a.getFormState()]))}return Promise.all(b)},dg.Form.prototype._submitForm=function(){for(var a=this,b=[],c=0;c<a.form._submit.length;c++){var d=a.form._submit[c].split("."),e=d[0],f=d[1];e!=this.getFormId()||"submitForm"!=f?window[e]&&window[e][f]&&b.push(window[e][f].apply(a,[a,a.getFormState()])):b.push(this[f].apply(a,[a,a.getFormState()]))}return Promise.all(b)},dg.addForm=function(a,b){return this.forms[a]=b,this.forms[a]},dg.loadForm=function(a){return this.forms[a]?this.forms[a]:null},dg.loadForms=function(){return this.forms},dg.removeForm=function(a){delete this.forms[a]},dg.removeForms=function(){this.forms={}},dg.isFormElement=function(a,b){return b.hasOwnProperty(a)&&"_"!=a.charAt(0)},dg.isFormProperty=function(a,b){return b.hasOwnProperty(a)&&"_"==a.charAt(0)},dg.setFormElementDefaults=function(a,b){var c=b._attributes?b._attributes:{};c.id||(c.id="edit-"+a),c.name||(c.name=a),c["class"]||(c["class"]=[]),b._attributes=c},dg["goto"]=function(a){this.router.navigate(a)},dg.alert=function(a){var b=null;arguments[1]&&(b=arguments[1]);var c=function(){},d="Alert",e="OK";b&&(b.alertCallback&&(c=b.alertCallback),b.title&&(d=b.title),b.buttonName&&(e=b.buttonName)),"phonegap"!=dg.config("mode")||"undefined"==typeof navigator.notification?(alert(a),c()):navigator.notification.alert(a,c,d,e)},dg.Module=function(){},dg.Module.prototype=new jDrupal.Module,dg.Module.prototype.constructor=dg.Module,dg.Module.prototype.routing=function(){return null},dg.Region=function(a){this.format="div";for(var b in a)a.hasOwnProperty(b)&&(this[b]=a[b])},dg.Region.prototype.get=function(a){return"undefined"!=typeof this[a]?this[a]:null},dg.Region.prototype.set=function(a,b){this[a]=b},dg.loadRegions=function(){},dg.Region.prototype.getBlocks=function(){var a=dg.blocksLoad(),b=[];for(var c in a)a.hasOwnProperty(c)&&a[c].get("region")==this.get("id")&&b.push(c);return b},dg.appRender=function(a){dg.themeLoad().then(function(b){var c="";dg.regions={};var d=b.getRegions();for(var e in d)if(d.hasOwnProperty(e)){var f={id:e,attributes:{id:e}},g=new dg.Region(f);for(var h in d[e])d[e].hasOwnProperty(h)&&g.set(h,d[e][h]);dg.regions[e]=g;var i=dg.regions[e].getBlocks();if(0!=i.length){c+="<"+g.get("format")+" "+dg.attributes(g.get("attributes"))+">";for(var j=0;j<i.length;j++){var k=dg.blockLoad(i[j]);c+="<"+k.get("format")+" "+dg.attributes(k.get("attributes"))+">",c+="</"+k.get("format")+">"}c+="</"+g.get("format")+">"}}c+=dg.render(a),document.getElementById("dg-app").innerHTML=c;var i=dg.blocksLoad(),l=[];for(e in i)i.hasOwnProperty(e)&&(l.push(e),i[e].buildWrapper().then(function(a){function b(a){a.preventDefault&&a.preventDefault();var b=dg.loadForm(d);return b._submission().then(function(){},function(){}),!1}if(document.getElementById(a.get("id")).innerHTML=dg.render(a.get("content")),l.splice(l.indexOf(a.get("id")),1),0==l.length){var c=dg.loadForms();for(var d in c)if(c.hasOwnProperty(d)){var e=dg.killCamelCase(d,"-"),f=document.getElementById(e);f.attachEvent?f.attachEvent("submit",b):f.addEventListener("submit",b)}}}))})},dg.render=function(a){try{var b=typeof a;if("string"===b)return a;var c="";if("object"===b){var d=a._prefix?a._prefix:"",e=a._suffix?a._suffix:"";if(a._markup)return d+a._markup+e;if(a._theme)return d+dg.theme(a._theme,a)+e;if(a._type)return d+dg.theme(a._type,a)+e;c+=d;for(var f in a)if(a.hasOwnProperty(f)&&"_prefix"!=f&&"_suffix"!=f){var g=a[f],h=typeof g;if("object"===h)c+=dg.render(g);else if("array"===h)for(var i=0;i<g.length;i++)c+=dg.render(g[i])}c+=e}else if("array"===b)for(var i=0;i<a.length;i++)c+=dg.render(a[i]);return c}catch(j){console.log("dg.render - "+j)}},dg.commentLoad=function(){return jDrupal.commentLoad.apply(jDrupal,arguments)},dg.nodeLoad=function(){return jDrupal.nodeLoad.apply(jDrupal,arguments)},dg.userLoad=function(){return jDrupal.userLoad.apply(jDrupal,arguments)},dg.token=function(){return jDrupal.token()},dg.restPath=function(){return jDrupal.restPath()},dg.router={routes:[],mode:null,root:"/",config:function(a){return this.mode=a&&a.mode&&"history"==a.mode&&history.pushState?"history":"hash",this.root=a&&a.root?"/"+this.clearSlashes(a.root)+"/":"/",this},getFragment:function(){var a="";if("history"===this.mode)a=this.clearSlashes(decodeURI(location.pathname+location.search)),a=a.replace(/\?(.*)$/,""),a="/"!=this.root?a.replace(this.root,""):a;else{var b=window.location.href.match(/#(.*)$/);a=b?b[1]:""}return this.clearSlashes(a)},prepFragment:function(a){var b=a||this.getFragment();return this.root+b},clearSlashes:function(a){return a.toString().replace(/\/$/,"").replace(/^\//,"")},add:function(a){return this.routes.push(a),this},remove:function(a){for(var b,c=0;c<this.routes.length,b=this.routes[c];c++)if(b.path.toString()===a.toString())return this.routes.splice(c,1),this;return this},flush:function(){return this.routes=[],this.mode=null,this.root="/",this},check:function(a){var b=this.load(a);if(b){dg.removeForms();var c=function(a){dg.content=a,dg.appRender()};if(b.defaults||(b=this.load(dg.config("front"))),b.defaults)if(b.defaults._form){var d=b.defaults._form;dg.addForm(d,new window[d]).getForm().then(c)}else b.defaults._controller().then(c)}return this},listen:function(){var a=this,b=a.getFragment(),c=function(){b!==a.getFragment()&&(b=a.getFragment(),a.check(b))};return clearInterval(this.interval),this.interval=setInterval(c,50),this},load:function(a){for(var b=this.prepFragment(a),c=0;c<this.routes.length;c++){var d=b.match(this.routes[c].path);if(d)return this.routes[c]}return null},navigate:function(a){if(a=a?a:"","history"===this.mode){var b=this.root+this.clearSlashes(a);history.pushState(null,null,b)}else window.location.href=window.location.href.replace(/#(.*)$/,"")+"#"+a;return this},getRoutes:function(){return this.routes},getRoute:function(){}},dg.Theme=function(){this.regions=null},dg.Theme.prototype.get=function(a){return"undefined"!=typeof this[a]?this[a]:null},dg.Theme.prototype.getRegions=function(){return this.get("regions")},dg.themeLoad=function(){return new Promise(function(a,b){if(!dg.activeTheme){var c=dg.config("theme"),d=jDrupal.ucfirst(dg.getCamelCase(c.name));dg.activeTheme=new window[d]}a(dg.activeTheme)})},dg.theme=function(a,b){try{if(b||(b={}),b._markup)return b._markup;var c="",d="theme_"+a;if(!jDrupal.functionExists(dg[d])){var e=null;arguments.callee.caller&&(e=arguments.callee.caller.name);var f="WARNING: "+d+"() does not exist.";return e&&(f+=" Called by: "+e+"()."),console.log(f),c}b._attributes||(b._attributes={}),b._attributes["class"]||(b._attributes["class"]=[]);var g=dg[d].call(null,b);return g instanceof Promise?(g.then(function(a){document.getElementById(a.variables._attributes.id).innerHTML=dg.render(a.content)}),"<div "+dg.attributes(b._attributes)+">hmmm...</div>"):g}catch(h){console.log("dg.theme - "+h)}},dg.currentUser=function(){return jDrupal.currentUser()},dg.userPassword=function(){return jDrupal.userPassword.apply(jDrupal,arguments)},dg.theme_view=function(a){if(!a._attributes.id){var b="WARNING: dg.theme_view - no attribute id was provided, so a random one was generated for the following View widget: "+dg.restPath()+a._path;console.log(b),a._attributes.id=dg.userPassword()}return new Promise(function(b){jDrupal.viewsLoad(a._path).then(function(c){var d=a._format?a._format:"div",e=a._format_attributes?a._format_attributes:null,f="<"+d+" "+dg.attributes(e)+">";if(c.results.length>0)for(var g=0;g<c.results.length;g++){var h,i="";switch(d){case"ul":case"ol":h="<li>",i="</li>";break;case"table":h="<tr>",i="</tr>"}f+=h+a._row_callback(c.results[g])+i}f+="</"+d+">",b({variables:a,content:f})})})},dg.l=function(a,b,c){return c||(c={}),c._text||(c._text=a),c._path||(c._path=b),dg.theme("link",c)},dg.theme_link=function(a){var b=a._text?a._text:"";return"undefined"==typeof a._attributes.href&&a._path&&(a._attributes.href="#"+a._path),"<a "+dg.attributes(a._attributes)+">"+b+"</a>"},dg.theme_item_list=function(a){var b="",c=a._type?a._type:"ul";if(a._title&&(b+="<h2>"+a._title+"</h2>"),b+="<"+c+" "+dg.attributes(a._attributes)+">",a._items&&a._items.length>0)for(var d in a._items)if(a._items.hasOwnProperty(d)){var e=a._items[d];b+="<li>"+e+"</li>"}return b+="</"+c+">"};var dgSystem=new dg.Module;dgSystem.blocks=function(){var a={};return a.main={build:function(){return new Promise(function(a,b){a(dg.content)})}},a};var UserLoginForm=function(){this.buildForm=function(a,b,c){return new Promise(function(b,c){a._action=dg.config("front"),a.name={_type:"textfield",_title:"Username",_required:!0,_title_placeholder:!0},a.pass={_type:"password",_title:"Password",_required:!0,_title_placeholder:!0},a.actions={_type:"actions",submit:{_type:"submit",_value:"Log in",_button_type:"primary"}},b(a)})},this.submitForm=function(a,b){return new Promise(function(a,c){jDrupal.userLogin(b.getValue("name"),b.getValue("pass")).then(a)})}};UserLoginForm.prototype=new dg.Form("UserLoginForm"),UserLoginForm.constructor=UserLoginForm;var dgUser=new dg.Module;dgUser.routing=function(){var a={};return a["user.login"]={path:"/user/login",defaults:{_form:"UserLoginForm",_title:"Log in"},requirements:{_user_is_logged_in:!0}},a};